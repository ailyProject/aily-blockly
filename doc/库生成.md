# 库生成  
aily blockly库基本遵循google blockly库结构，并对此进行了简化和扩展。  

库存存放路径：`\resources\app\libraries`，您可以参照我提供的库，开发自己的库。  

传统blockly库分为三部分：block、generator、toolbox，作用分别如下：  
block：定义block样式  
generator：定义block生成的代码  
toolbox：配置边栏中显示的block  

aily blockly库保留blockly原始设计，并在block中添加了generator关键字用于快速生成代码。

## 库结构
一个aily blockly库的结构如下
```json
library-name  
 |- block.json             // aily blockly block文件
 |- generator.js           // aily blockly generator文件（可以没有）
 |- toolbox.json           // aily blockly toolbox文件
 |- package.json           // 项目管理文件
 |- project-name.zip       // Arduino库源文件
 |- examples               // 库示例程序
     |- ex1.json
     |- ex2.json
```

## block.json
aily blockly json在原始的blockly json上进行了扩展。这里以servo lib（舵机库）为例进行说明，舵机库json如下：  
```json
[
    {
        "inputsInline": true,
        "message0": "舵机%1移动到%2",
        "type": "servo1_write",
        "args0": [
            {
                "type": "field_variable",
                "name": "OBJECT",
                "variable": "servo1",
                "variableTypes": [
                    "Servo"
                ],
                "defaultType": "Servo"
            },
            {
                "type": "field_number",
                "name": "ANGLE",
                "value": 0
            }
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": "#03a9f4",
        "generator": {
            "code": "${OBJECT}.write(${ANGLE});"
        }
    },
    {
        "inputsInline": true,
        "message0": "舵机%1连接到引脚%2",
        "type": "servo1_attach",
        "args0": [
            {
                "type": "field_variable",
                "name": "OBJECT",
                "variable": "servo1",
                "variableTypes": [
                    "Servo"
                ],
                "defaultType": "Servo"
            },
            {
                "type": "field_dropdown",
                "name": "PIN1",
                "options": "${board.digitalPins}"
            }
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": "#03a9f4",
        "generator": {
            "code": "${OBJECT}.attach(${PIN1});",
            "library": "#include <Servo.h>",
            "object": "Servo ${OBJECT};"
        }
    }
]
```

### block配置  
json文件中`blocks数组`即是具体的block配置，可以参照[blockly官方文档](https://developers.google.com/blockly/guides/create-custom-blocks/define-blocks)了解相关配置。  
单一block示例如下：  

```json
{
    "inputsInline": true,              // block样式，true输入项目为一行显示，flase为多行显示
    "message0": "舵机%1连接到引脚%2",   // block信息，定义该block上显示的内容
    "type": "servo1_attach",           // block类型，该参数必须是唯一的
    "previousStatement": null,         // 前置连接，配置该block之前的block类型  
    "nextStatement": null,             // 后置连接，配置该block之后的block类型  
    "colour": "#03a9f4",               // block颜色
    "args0": [                         // 输入项
        {
            "type": "field_variable",
            "name": "OBJECT",
            "variable": "servo1",
            "variableTypes": [
                "Servo"
            ],
            "defaultType": "Servo"
        },
        {
            "type": "field_dropdown",
            "name": "PIN1",
            "options": "${board.digitalPins}"
        }
    ],
    // 代码生成器配置
    "generator": {
        "code": "${OBJECT}.attach(${PIN1});",
        "library": "#include <Servo.h>",
        "object": "Servo ${OBJECT};"
    }
}
```
其中generator配置，都是aily blockly提供扩展配置。 

#### generator配置  
generator配置是用于快速生成代码的配置，在**简单场景**下，可以替代原始的blockly generator js文件。

##### 代码结构  
对于一个Arduino程序，可以切分为以下部分：  
```c++
// [宏定义 macros]

// [库引用 libraries]
#include <Servo.h>
// [变量 variables]
static const int servoPin = 4;
// [对象 objects]
Servo servo1;
// [函数 functions]

void setup() {
// [初始化部分 setups]

// [用户自定义 userSetups]
    Serial.begin(115200);
    servo1.attach(servoPin);
}

void loop() {
// [主程序 loops]
    for(int posDegrees = 0; posDegrees <= 180; posDegrees++) {
        servo1.write(posDegrees);
        Serial.println(posDegrees);
        delay(20);
    }

    for(int posDegrees = 180; posDegrees >= 0; posDegrees--) {
        servo1.write(posDegrees);
        Serial.println(posDegrees);
        delay(20);
    }
}
```

回到generator配置中，其中对应的代码会被插入到程序中对应的位置。
```json
"generator": {   // 代码生成器配置
    "code": "${OBJECT}.write(${ANGLE});",   // block对应的代码主体部分
    "libraries": "#include <Servo.h>",      // 向[库引用 libraries]部分添加的代码
    "object": "Servo ${OBJECT};"            // 向[对象 objects]部分添加的代码
},
```

如图：  




##### 变量
aily blockly配置支持变量，变量形式为`${VAR_NAME}`，其中`VAR_NAME`即是`args0`中输入项`name`。
aily blockly会自动将代码中的变量，替换为变量对应的值。  
如图：  

## generator.js 
aily blockly库将block、toolbox做了合并和扩展，并简化了generator部分，上一节已经介绍了block、toolbox合并后的json库，其中对应的内容，可以取代generator部分生成对应代码。但aily blockly的快速生成代码功能，只能满足部分简单需求。如果有复杂的代码转换需求，还需要添加js部分来实现。  

## toolbox.json 
```json

```

## package.json
版本控制文件，采用npm包管理,示例如下：
```json
{
    "name": "aily-blockly/core/io",
    "author": "奈何col",
    "description": "舵机控制支持库，支持Arduino UNO、MEGA、ESP8266、ESP32等开发板",
    "version": "0.0.1",
    "config": {
        "category": "I/O",
        "icon": "fal fa-microchip",
        "colour": "#66bb6a"
    },
    "compatibility": {
        "core": [
            "arduino:avr",
            "esp32:esp32",
            "esp8266:esp8266"
        ],
        "voltage": [3.3,5]
    },
    "keywords": [
        "aily",
        "blockly",
        "core",
        "io"
    ],
    "scripts": {},
    "private": true,
    "dependencies": {},
    "devDependencies": {}
}
```


## 云端库提交要求
1. 一个库的相关文件请都存放在一个文件夹内  
2. json、js文件应同名  
3. 如包含arduino的C++库，请打包成zip文件，并和json文件同名。  